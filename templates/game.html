<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Matching Game - Play</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
        }
        .container {
            padding: 20px;
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .player-area, .chatbox, .log-area {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .log-area {
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ room.name }}</h1>
        <div id="room-info"></div>
        <div id="similarity-story"></div>
        <div class="player-list" id="players"> <!--플레이어 목록이 동적으로 추가-->
            {% for player in room.players %}
                <div class="player">{{ player.name }}</div>
            {% endfor %}
        </div>
        <form id="form">
            <input placeholder="추측할 단어를 입력하세요" autocorrect="off" autocapitalize="none" autocomplete="off"
                        type="text" id="guess" autofocus>
            <button type="submit">추측하기</button>
        </form>
        <div id="error" style="color: red; margin: 10px 0;"></div>
        <div class="log-area">
            <h3>Guess Log</h3>
            <table id="guesses" style="width: 100%; text-align: left;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Word</th>
                        <th>Similarity</th>
                        <th>Rank</th>
                    </tr>
                </thead>
                <tbody>
                    <!--추측기록이 여기에 추가 됨-->
                </tbody>
            </table>
        </div>
        <button onclick="exitGame()">Exit</button>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    const socket = io({
        transports: ['websocket'],
        upgrade: false
    });

    // 모든 소켓 이벤트 로깅
    socket.onAny((eventName, ...args) => {
        console.log('Socket Event:', eventName, 'Data:', args);
    });
    
    const roomId = new URLSearchParams(window.location.search).get('room_id');
    const username = localStorage.getItem('username') || 'Guest';
    let guessed = new Set();

    // room-info 업데이트
    document.getElementById('room-info');

    // 방 참가
    socket.emit('join_room', {
        room_id: roomId,
        username: username
    });

    // 플레이어 목록 업데이트 함수
    function updatePlayerList(players) {
        console.log('updatePlayerList called with:', players);
        const playerList = document.getElementById('players');
        if (!playerList) {
            console.error('Player list element not found');
            return;
        }

        const playerHTML = players.map(player => {
            console.log('Creating player element for:', player);
            return `<div class="player">${player}</div>`;
        }).join('');
        
        console.log('Setting player list HTML:', playerHTML);
        playerList.innerHTML = playerHTML;
    }

    // 추측 기록 업데이트 함수
    function updateGuessLog(guessHistory) {
        console.log('updateGuessLog called with:', guessHistory);
        const guessTable = document.getElementById('guesses');
        if (!guessTable) {
            console.error('Guess table not found');
            return;
        }
        
        const tbody = guessTable.querySelector('tbody');
        if (!tbody) {
            console.error('Table body not found');
            return;
        }

        const rowsHTML = guessHistory.map((guess, index) => {
            console.log('Creating row for guess:', guess);
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${guess.guess}</td>
                    <td>${(guess.similarity * 100).toFixed(2)}%</td>
                    <td>${guess.username}</td>
                </tr>
            `;
        }).join('');
        
        console.log('Setting table HTML:', rowsHTML);
        tbody.innerHTML = rowsHTML;
    }

    // Socket.IO 이벤트 리스너
    socket.on('room_joined', function(data) {
        console.log('Room joined - Full data:', data);
        if (data.players) {
            console.log('Players data received:', data.players);
            updatePlayerList(data.players);
        }
        if (data.guess_history) {
            console.log('Guess history received:', data.guess_history);
            updateGuessLog(data.guess_history);
        }
    });

    socket.on('ready_to_start', function(data) {
        console.log('Ready to start - Full data:', data);
        if (!document.getElementById('start-button')) {
            const startButton = document.createElement('button');
            startButton.id = 'start-button';
            startButton.textContent = '게임 시작';
            startButton.onclick = function() {
                socket.emit('start_game', { room_id: roomId });
            };
            const form = document.getElementById('form');
            form.parentNode.insertBefore(startButton, form);
        }
    });

    socket.on('game_started', function(data) {
        console.log('Game started:', data);
        const startButton = document.getElementById('start-button');
        if (startButton) startButton.remove();
        document.getElementById('form').style.display = 'block';
        document.getElementById('error').textContent = data.message;
    });

    socket.on('guess_result', function(data) {
        console.log('Guess result received:', data);
        document.getElementById('error').textContent = '';
        if (data.guess_history) {
            console.log('Updating guess history with:', data.guess_history);
            updateGuessLog(data.guess_history);
        }
    });

    socket.on('game_over', function(data) {
        console.log('Game over:', data);
        alert(`게임 종료! 승자: ${data.winner}\n정답: ${data.word}`);
        document.getElementById('form').style.display = 'none';
        if (data.guess_history) {
            updateGuessLog(data.guess_history);
        }
    });

    socket.on('error', function(data) {
        document.getElementById('error').textContent = data.message;
        console.log('Error:', data.message);
    });

    // 추측 제출 이벤트
    document.getElementById('form').addEventListener('submit', function(event) {
        event.preventDefault();
        const guessInput = document.getElementById('guess');
        const guess = guessInput.value.trim();
        
        if (!guess) {
            document.getElementById('error').textContent = "단어를 입력하세요";
            return;
        }

        if (guessed.has(guess)) {
            document.getElementById('error').textContent = "이미 시도한 단어입니다";
            return;
        }

        console.log('Submitting guess:', guess);
        socket.emit('submit_guess', {
            room_id: roomId,
            username: username,
            guess: guess
        });

        guessed.add(guess);
        guessInput.value = '';
    });

    // 게임 나가기
    window.exitGame = function() {
        console.log('Leaving room:', roomId);
        socket.emit('leave_room', {
            room_id: roomId,
            username: username
        });
        window.location.href = '/';
    };

    // 연결 해제 시
    socket.on('disconnect', function() {
        console.log('Disconnected from server');
    });

    // 플레이어 퇴장 시
    socket.on('player_left', function(data) {
        console.log('Player left:', data);
        if (data.players) {
            updatePlayerList(data.players);
        }
    });
});
    </script>
</body>
</html>
