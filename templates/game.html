{% extends "base.html" %}

{% block title %}게임 플레이{% endblock %}

{% block styles %}
<style>
    .player-area, .chatbox, .log-area {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fafafa;
    }
    .log-area {
        max-height: 400px;
        overflow-y: auto;
    }
    #guess-form {
        margin: 20px 0;
    }
    #guess {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-right: 10px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        text-align: center;
    }
    th {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ room.name if room else "게임방 선택" }}</h1>
    
    {% if room %}
        <div class="player-area">
            <h3>참가자 목록</h3>
            <ul id="players">
                {% for player in room.players %}
                    <li>{{ player }}</li>
                {% endfor %}
            </ul>
        </div>

        <form id="guess-form">
            <input type="text" id="guess" placeholder="추측할 단어를 입력하세요">
            <button type="submit" class="btn btn-primary">추측하기</button>
        </form>

        <div class="log-area">
            <table id="guesses">
                <tr>
                    <th>#</th>
                    <th>단어</th>
                    <th>유사도</th>
                    <th>순위</th>
                </tr>
            </table>
        </div>
    {% else %}
        <div class="room-list">
            <p>참여할 수 있는 게임방이 없습니다.</p>
            <button onclick="window.location.href='/'" class="btn btn-primary">메인으로 돌아가기</button>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const guesses = [];
    const guessed = new Set();

    document.getElementById('guess-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const guess = document.getElementById('guess').value.trim();
        
        if (!guess || guessed.has(guess)) return;
        
        socket.emit('make_guess', {
            room_id: '{{ room_id }}',
            guess: guess
        });
        
        document.getElementById('guess').value = '';
    });

    socket.on('guess_result', function(data) {
        if (data.error) {
            alert(data.error);
            return;
        }

        guessed.add(data.guess);
        guesses.push([data.similarity, data.guess, guesses.length + 1]);
        updateGuessLog();
    });

    socket.on('player_left', function(data) {
        const playersList = document.getElementById('players');
        playersList.innerHTML = data.players.map(player => 
            `<li>${player}</li>`
        ).join('');
    });

    function updateGuessLog() {
        const table = document.getElementById('guesses');
        table.innerHTML = `<tr><th>#</th><th>단어</th><th>유사도</th><th>순위</th></tr>`;
        guesses.forEach(([similarity, word, index]) => {
            table.innerHTML += `
                <tr>
                    <td>${index}</td>
                    <td>${word}</td>
                    <td>${(similarity * 100).toFixed(2)}%</td>
                    <td>${index}</td>
                </tr>`;
        });
    }
</script>
{% endblock %}
